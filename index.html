<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    
    <title>Let's Work</title>
    <script>
        (function() {
            const ua = navigator.userAgent.toLowerCase();
            const isAndroid = /android/i.test(ua);
            const isIos = /iphone|ipad|ipod/i.test(ua);
            const url = window.location.href;

            // 1. ì•ˆë“œë¡œì´ë“œ íƒˆì¶œ ë¡œì§ (ê¸°ì¡´ ìœ ì§€)
            if (isAndroid) {
                const isAndroidWebView = (/wv/i.test(ua) || /version\/[\d.]+/i.test(ua)) && 
                                        (ua.indexOf('naver') !== -1 || ua.indexOf('kakaotalk') !== -1 || ua.indexOf('instagram') !== -1);
                if (isAndroidWebView) {
                    location.href = `intent://${url.replace(/^https?:\/\//, '')}#Intent;scheme=https;action=android.intent.action.VIEW;end`;
                    return;
                }
            }

            // 2. iOS ì¸ì•± ë¸Œë¼ìš°ì € ê°ì§€ (ìˆ˜ì •ë¨)
                if (isIos) {
            // 1. ì§„ì§œ Safariì¸ì§€ í™•ì¸í•˜ëŠ” í•µì‹¬ ì¡°ê±´
            // - Safarië¼ëŠ” ê¸€ìê°€ ìˆì–´ì•¼ í•¨
            // - Versionì´ë¼ëŠ” ê¸€ìê°€ ìˆì–´ì•¼ í•¨ (ì¸ì•± ë¸Œë¼ìš°ì €ë‚˜ í¬ë¡¬ ë“±ì€ ì´ê²Œ ë¹ ì§€ëŠ” ê²½ìš°ê°€ ë§ìŒ)
            // - ë‹¤ë¥¸ ì•± ì‹ë³„ì(naver, kakao, instagram ë“±)ê°€ ì—†ì–´ì•¼ í•¨
            const isRealSafari = /safari/i.test(ua) && 
                                /version/i.test(ua) && 
                                !/naver|kakaotalk|instagram|line|fbav|fban|puffin|fios|tistory/i.test(ua);

            // 2. í¬ë¡¬ì´ë‚˜ ë‹¤ë¥¸ ì •ì‹ ë¸Œë¼ìš°ì €ëŠ” í†µê³¼ì‹œì¼œì£¼ê³  ì‹¶ë‹¤ë©´?
            const isOtherFullBrowser = /crios|fxios|optios|edgios/i.test(ua); // í¬ë¡¬, íŒŒì´ì–´í­ìŠ¤, ì˜¤í˜ë¼, ì—£ì§€(iOSìš©)

            // ì •ì‹ ë¸Œë¼ìš°ì €ê°€ ì•„ë‹ˆë¼ë©´ ì•ˆë‚´ì°½ ë„ìš°ê¸°
            if (!isRealSafari && !isOtherFullBrowser) {
                if (document.readyState === 'loading') {
                    window.addEventListener('DOMContentLoaded', showIosGuide);
                } else {
                    showIosGuide();
                }
            }
        }
        })();

        // ì•„ì´í° ìœ ì €ë¥¼ ìœ„í•œ ì•ˆë‚´ì°½ ìƒì„± í•¨ìˆ˜
        function showIosGuide() {
            const guide = document.createElement('div');
            guide.id = 'ios-guide-overlay';
            guide.style = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                background: rgba(0,0,0,0.92); z-index: 999999;
                display: flex; flex-direction: column; justify-content: center; align-items: center;
                color: white; text-align: center; font-family: -apple-system, sans-serif;
            `;
            
            guide.innerHTML = `
                <div style="background: #222; padding: 30px; border-radius: 20px; border: 1px solid #2ed573; max-width: 85%;">
                    <h2 style="color: #2ed573; margin-top: 0; font-size: 20px;">ğŸ“¢ êµ¬ê¸€ ë¡œê·¸ì¸ ì•ˆë‚´</h2>
                    <p style="font-size: 14px; line-height: 1.6; color: #ccc;">
                        ì•„ì´í° ë³´ì•ˆ ì •ì±…ìœ¼ë¡œ ì¸í•´ ì•± ë‚´ë¶€ ë¸Œë¼ìš°ì €ì—ì„œëŠ” êµ¬ê¸€ ë¡œê·¸ì¸ì´ ì°¨ë‹¨ë©ë‹ˆë‹¤.
                    </p>
                    <div style="margin: 20px 0; padding: 15px; background: #333; border-radius: 12px;">
                        <p style="margin: 0; font-size: 13px; color: #fff;">í•˜ë‹¨ <b>ê³µìœ  ë²„íŠ¼(â–¡â†‘)</b>ì„ ëˆ„ë¥¸ ë’¤</p>
                        <p style="margin: 8px 0 0; font-size: 16px; color: #2ed573; font-weight: bold;">'Safarië¡œ ì—´ê¸°'</p>
                    </div>
                    <button onclick="document.getElementById('ios-guide-overlay').remove()" 
                        style="background: #444; color: white; border: none; padding: 12px 20px; border-radius: 10px; cursor: pointer; font-size: 14px;">
                        ë‹«ê¸°
                    </button>
                </div>
            `;
            document.body.appendChild(guide);
        }
    </script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <style>
        /* 1. ê°€ì¥ ìƒë‹¨ì— @font-faceë¥¼ ì„ ì–¸í•©ë‹ˆë‹¤. */
        @font-face {
            font-family: 'Gameplay'; /* ë‚´ê°€ ë¶€ë¥¼ ì´ë¦„ */
            src: url('fonts/Gameplay.woff2?v=1.0.1') format('woff2');
            font-weight: normal;
            font-style: normal;
        }

        /* 2. ê¸°ì¡´ body ìŠ¤íƒ€ì¼ì€ ìœ ì§€ (ì „ì²´ í°íŠ¸ ë°©í•´ ê¸ˆì§€) */
        body { 
            letter-spacing: -0.03em; /* ìê°„ ì¡°ì ˆ */
            word-break: keep-all;    /* ë‹¨ì–´ ë‹¨ìœ„ ì¤„ë°”ê¿ˆìœ¼ë¡œ ê°€ë…ì„± í–¥ìƒ */
            text-align: center; 
            font-family: sans-serif; 
            background: #111; 
            color: white; 
            margin: 0; 
            padding: 0; 
        }

        /* 3. h1 íƒœê·¸ì—ë§Œ í•´ë‹¹ í°íŠ¸ ì ìš© */
        h1 {
            font-family: 'Gameplay', sans-serif !important;
            font-size: 42px; /* í°íŠ¸ì— ë”°ë¼ í¬ê¸°ê°€ ì‘ì•„ ë³´ì¼ ìˆ˜ ìˆìœ¼ë‹ˆ ì¡°ì ˆí•˜ì„¸ìš” */
            letter-spacing: 1px; /* ì˜ë¬¸ í°íŠ¸ë¼ë©´ ìê°„ì„ ì¡°ê¸ˆ ë„“íˆë©´ ë” ì˜ˆì©ë‹ˆë‹¤ */
        }
        /* [ê¸°ë³¸ ìŠ¤íƒ€ì¼] */
        body { text-align: center; font-family: sans-serif; background: #111; color: white; margin: 0; padding: 20px; -webkit-text-size-adjust: none; }
        .login-section { margin-top: 38px; display: flex; flex-direction: column; align-items: center; gap: 10px; }
        .user-info { font-size: 16px; color: #2ed573; font-weight: bold; min-height: 20px; margin-bottom: 25px; align-items: center; /* ìì‹ ìš”ì†Œë“¤ì„ ê°€ë¡œ ì¤‘ì•™ìœ¼ë¡œ ì •ë ¬ */}
        video { width: 100%; max-width: 500px; border-radius: 15px; background: #333; margin-top: 20px; }
        .btn-group { display: flex; justify-content: center; gap: 10px; margin-top: 15px; max-width: 500px; margin-left: auto; margin-right: auto; }
        .main-btn { padding: 14px; border-radius: 12px; border: none; cursor: pointer; font-weight: bold; font-size: 16px; transition: 0.3s; flex: 1; }
        
        /* [ë©”ë‰´ ë° ê¸°íƒ€ ë·° ìˆ¨ê¹€ ì„¤ì •] */
        #mainMenuView, #cameraView, #loadingView, #resultView, #historyView { display: none; }
        
        
        /* [ë‹¬ë ¥ ë° ë¦¬í¬íŠ¸ ìŠ¤íƒ€ì¼ - ê¸°ì¡´ ìœ ì§€] */
/* íƒ­ ì˜ì—­ì„ ê°ì‹¸ëŠ” ë¶€ëª¨ (í˜ì´ë“œ íš¨ê³¼ ê³ ì •ìš©) */
.tabs-wrapper {
    position: relative;
    max-width: 500px;
    margin: 20px auto 0;
    overflow: hidden;
    /* í•˜ë‹¨ report-cardì™€ ìì—°ìŠ¤ëŸ½ê²Œ ì´ì–´ì§€ë„ë¡ ë°°ê²½ìƒ‰ í†µì¼ */
    background-color: #111; 
}

#loadingView {
    display: none; /* ê¸°ë³¸ì€ ìˆ¨ê¹€ */
    flex-direction: column;
    align-items: center;
    justify-content: center;
    position: fixed; /* í™”ë©´ì— ê³ ì • */
    top: 0; left: 0;
    width: 100%; height: 100%;
    background-color: rgba(0, 0, 0, 0.8); /* ë°°ê²½ì„ ì–´ë‘¡ê²Œ í•´ì„œ ì§‘ì¤‘ë„ í–¥ìƒ */
    z-index: 1000;
}

.tabs-container {
    gap: 12px !important;
    padding: 10px 0;
    display: flex;
    justify-content: flex-start;
    overflow-x: auto;
    padding-right: 60px; /* ë§ˆì§€ë§‰ ë²„íŠ¼ì´ ê°€ë ¤ì§€ì§€ ì•Šê²Œ ì—¬ìœ  í™•ë³´ */
    -webkit-overflow-scrolling: touch;
    -ms-overflow-style: none;  /* IE and Edge */
    scrollbar-width: none;  /* Firefox */
}

/* í¬ë¡¬, ì‚¬íŒŒë¦¬, ìµœì‹  ë¸Œë¼ìš°ì €ìš© ìŠ¤í¬ë¡¤ë°” ìˆ¨ê¸°ê¸° */
.tabs-container::-webkit-scrollbar {
    display: none;
}

/* ë…¹í™” ì¤‘ì¼ ë•Œ ê¹œë°•ì´ëŠ” ë¹¨ê°„ ì  */
.recording-dot {
    width: 12px;
    height: 12px;
    background-color: #ff4757;
    border-radius: 50%;
    display: inline-block;
    margin-right: 8px;
    animation: blink 1s infinite;
    vertical-align: middle;
}

@keyframes blink {
    0% { opacity: 1; }
    50% { opacity: 0; }
    100% { opacity: 1; }
}

/* ì„ ì´ ë‚¨ì§€ ì•Šë„ë¡ ì™„ë²½í•˜ê²Œ ë®ëŠ” ì˜¤ë²„ë ˆì´ */
.fade-overlay {
    position: absolute;
    top: 0;
    right: -2px; /* ì‚´ì§ ë” ì˜¤ë¥¸ìª½ìœ¼ë¡œ ë°€ì–´ì„œ ë¸Œë¼ìš°ì € ë Œë”ë§ ì˜¤ì°¨ ë°©ì§€ */
    width: 60px;
    height: 100%;
    /* 111 ë°°ê²½ìƒ‰ê³¼ ì†Œìˆ˜ì ê¹Œì§€ ì¼ì¹˜í•˜ë„ë¡ ì²˜ë¦¬ */
    background: linear-gradient(to right, 
        rgba(17, 17, 17, 0) 0%, 
        rgba(17, 17, 17, 0.9) 70%, 
        rgba(17, 17, 17, 1) 100%
    );
    pointer-events: none;
    z-index: 100; /* ëª¨ë“  ìš”ì†Œ ìœ„ì— ë°°ì¹˜ */
}

    /* [ì¶”ê°€] ë‹¬ë ¥ í•˜ë‹¨ í”„ë¦¬ë·° ìŠ¤íƒ€ì¼ */
    .day-preview {
        max-width: 500px;
        margin: 10px auto;
        padding: 10px;
        background: #1a1f1c; 
        border-radius: 18px;
        border: 1px solid rgba(46, 213, 115, 0.1);
        min-height: 50px;
        text-align: left;
        /* ğŸ“ ì•„ë˜ 3ì¤„ì´ í…ìŠ¤íŠ¸ë¥¼ ì •ì¤‘ì•™ìœ¼ë¡œ ë³´ë‚´ì¤ë‹ˆë‹¤ */
        display: flex; 
        flex-direction: column;
        justify-content: center;
    }

    .preview-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 8px;
        padding: 8px;
        background: rgba(255, 255, 255, 0.03);
        border-radius: 8px;
    }

    .preview-item:active {
    background: rgba(46, 213, 115, 0.1);
    transform: scale(0.98);
    }

    .preview-tag {
        background: #2ed573;
        color: #111;
        font-size: 11px;
        padding: 2px 8px;
        border-radius: 20px;
        font-weight: bold;
    }

    .tab-btn {
    border-radius: 12px; /* ìœ„ìª½ë§Œ ì‚´ì§ ë‘¥ê¸€ê²Œ */
    background: #222;
    border: none;
    padding: 10px;
}
    .tab-btn.active { background: #121B15; color: #2ed573; border: 1px solid #121B15; font-weight: 700; z-index: 3; }
            .chips-container { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 25px; }
    .set-chip { background: #1a1f1c; border-radius: 12px; border: 1px solid rgba(255, 255, 255, 0.05); /* ê²½ê³„ì„  ì¶”ê°€ */ box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3); /* ê¹Šì´ê° ë¶€ì—¬ */padding: 10px; border-radius: 12px; flex: 0 0 calc(50% - 5px); box-sizing: border-box; display: flex; flex-direction: column; align-items: center; }
    .set-value { color: #2ed573; font-weight: bold; font-size: 18px; }
        /* AI í”¼ë“œë°±: ë‹¬ë ¥ í”„ë¦¬ë·° ìŠ¤íƒ€ì¼ ê³„ìŠ¹ */
        .feedback-box {
            background: rgba(255,255,255,0.03) !important;
            border-left: 3px solid #2ed573; /* í¬ì¸íŠ¸ë§Œ ì‚´ë¦¼ */
            padding: 15px !important;
            line-height: 1.8;
            letter-spacing: -0.01em;    /* ìê°„ ë¯¸ì„¸í•˜ê²Œ ì¶•ì†Œ */
            font-size: 14px;
    }
    .calendar-wrapper { max-width: 500px; margin: 0 auto; position: relative; overflow: hidden; padding-bottom: 10px; }
    .calendar-header { display: flex; justify-content: space-between; align-items: center; padding: 10px; }
    .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; }
    .calendar-day { aspect-ratio: 1/1; display: flex; flex-direction: column; align-items: center; justify-content: center; border-radius: 10px; background: #222; cursor: pointer; font-size: 13px; }
    .calendar-day.active { background: #121B15; border: 1px solid #2ed573; }
    .day-names { display: grid; grid-template-columns: repeat(7, 1fr); color: #666; font-size: 12px; margin-bottom: 5px; }
    .report-card {
        background: #111 !important; /* ë°°ê²½ìƒ‰ í†µì¼ */
        border: none !important;     /* ê³¼í•œ í…Œë‘ë¦¬ ì‚­ì œ */
        padding: 10px 0;             /* ì¢Œìš° ì—¬ë°±ì„ ë¹¼ì„œ ë‹¬ë ¥ê³¼ í­ì„ ë§ì¶¤ */
    }
    .loader { border: 6px solid #333; border-top: 6px solid #2ed573; border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; margin: 30px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>
</div>

<script>
function testLoadingUI() {
    // 1. ëª¨ë“  ë·° ìˆ¨ê¸°ê³  ë¡œë”© ë·° í‘œì‹œ
    document.getElementById('loginArea').style.display = 'none';
    document.getElementById('mainMenuView').style.display = 'none';
    const loadingView = document.getElementById('loadingView');
    loadingView.style.display = 'flex'; // í˜¹ì€ 'block'

    // 2. í…ìŠ¤íŠ¸ ë³€ê²½ í…ŒìŠ¤íŠ¸
    const messages = [
        "ğŸ“¥ ì„œë²„ì— ì˜ìƒ ìˆ˜ì‹  ì™„ë£Œ...",
        "âš™ï¸ AI ë¶„ì„ì„ ìœ„í•´ ì˜ìƒ ìµœì í™” ì¤‘...",
        "â˜ï¸ AI ì„œë²„ë¡œ ì˜ìƒ ì „ì†¡ ì¤‘...",
        "ğŸ¤– AIê°€ ì˜ìƒì„ ì½ê³  ìˆìŠµë‹ˆë‹¤...",
        "ğŸ§ ìì„¸ ë¶„ì„ ë° ìš´ë™ íšŸìˆ˜ ê¸°ë¡ ì¤‘..."
    ];

    let i = 0;
    const interval = setInterval(() => {
        if (i < messages.length) {
            // ìœ„ ë‹µë³€ì—ì„œ ìˆ˜ì •í•œëŒ€ë¡œ id="loadingText"ê°€ ìˆì–´ì•¼ ì‘ë™í•©ë‹ˆë‹¤.
            const txt = document.getElementById('loadingText');
            if(txt) txt.innerText = messages[i];
            i++;
        } else {
            clearInterval(interval);
            alert("í…ŒìŠ¤íŠ¸ ì™„ë£Œ! í™”ë©´ì„ ìƒˆë¡œê³ ì¹¨í•˜ì„¸ìš”.");
        }
    }, 1500); // 1.5ì´ˆ ê°„ê²©ìœ¼ë¡œ í…ìŠ¤íŠ¸ ë³€ê²½
}
</script>

    <div class="login-section" id="loginArea">
        <h1 style="color: #2ed573; margin-bottom: 22px;">LET'S WORK</h1>
        <div id="userInfo" class="user-info">ìš´ë™ì„ ê¸°ë¡í•˜ë ¤ë©´ ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.</div>
        <div id="g_id_onload"
             data-client_id="432545887591-qmuctqe2v3nd1355mvfegp4uk9d0gbs8.apps.googleusercontent.com" 
             data-callback="handleCredentialResponse">
        </div>
        <div class="g_id_signin"
     data-type="standard"
     data-shape="pill"       data-theme="outline"    data-size="large"       data-text="signin_with" data-width="250">       </div>
    </div>

    <div id="mainMenuView">
        <div class="btn-group" style="flex-direction: column; width: 80%; max-width: 300px; margin: 0 auto;">
            <button id="startReadyBtn" class="main-btn" style="background: #ff4757; color: white; margin-bottom: 15px;">ğŸ”¥ ìš´ë™ ì‹œì‘</button>
            <button id="historyBtn" class="main-btn" style="background: #2ed573; color: white;">ğŸ“œ ê¸°ë¡ í™•ì¸</button>
            <button onclick="logout()" style="background:none; border:none; color:#666; margin-top:20px; cursor:pointer; text-decoration:underline;">ë¡œê·¸ì•„ì›ƒ</button>
        </div>
    </div>

    <div id="cameraView">
        <div id="recordingStatus" style="margin-bottom: 0px; margin-top: 10px; font-weight: bold; font-size: 16px; color: #2ed573;">
            ìš°ì˜¤ì•„ã…—ì•„ì˜¤
        </div>
        <video id="preview" autoplay muted playsinline></video>
        <div class="btn-group">
            <button id="recordBtn" class="main-btn" style="background: #ff4757; color: white;">ğŸ”´ ë…¹í™” ì‹œì‘</button>
            <button id="stopBtn" class="main-btn" style="background: #2f3542; color: white; display: none;">â¹ï¸ ì´¬ì˜ ì™„ë£Œ</button>
            <button onclick="location.reload()" class="main-btn" style="background: #444; color: white;">ì·¨ì†Œ</button>
        </div>
    </div>

    <div id="loadingView">
        <div class="loader"></div>
        <h2 id="loadingText" style="color: #2ed573; margin-top: 20px;">ğŸš€ ì˜ìƒ ë°ì´í„°ë¥¼ ì„œë²„ë¡œ ì˜®ê¸°ëŠ” ì¤‘....</h2>
    </div> <div id="resultView"></div>
    <div id="historyView">
        <h2 style="color: #2ed573;">ğŸ“… ë‚˜ì˜ ìš´ë™ ê¸°ë¡</h2>
        <div id="historyList"></div>

        <div id="dayPreview" class="day-preview">
            <p style="color: #666; font-size: 13px; text-align: center;">ë‚ ì§œë¥¼ ì„ íƒí•˜ë©´ ìš´ë™ ìš”ì•½ì´ í‘œì‹œë©ë‹ˆë‹¤.</p>
        </div>
    
        <button onclick="location.reload()" class="main-btn" style="background: #444; color: white; margin-top: 20px;">í™ˆìœ¼ë¡œ</button>
    </div>

    <script>
        let mediaRecorder, recordedChunks = [], workoutResults = [], userProfile = null, idToken = null;
        let viewMode = "new"; // ì¶”ê°€
        let currentIndex = 0; // ì¶”ê°€
        const videoElement = document.getElementById('preview');

        // [3ë²ˆ] ê¸°ì¡´ window.onload ìˆ˜ì •
        window.onload = () => {
            const saved = localStorage.getItem("userProfile");
            const savedToken = localStorage.getItem("idToken");
            if (saved && savedToken) {
                userProfile = JSON.parse(saved);
                idToken = savedToken;
                showMainMenu();
                startTokenRefreshLoop(); // ğŸ‘ˆ ì ‘ì† ì‹œ ë£¨í”„ ì‹œì‘
            }
        };

        // [3ë²ˆ] ê¸°ì¡´ handleCredentialResponse ìˆ˜ì •
        function handleCredentialResponse(response) {
            console.log("ğŸ”‘ ìƒˆ í† í° ìˆ˜ì‹  ì™„ë£Œ");
            idToken = response.credential; // ğŸ“ ì „ì—­ ë³€ìˆ˜ ìµœì‹ í™”
            const payload = parseJwtPayload(idToken);
            userProfile = { id: payload.sub, name: payload.name };
            
            localStorage.setItem("userProfile", JSON.stringify(userProfile));
            localStorage.setItem("idToken", idToken);
            
            showMainMenu();
            startTokenRefreshLoop(); // ğŸ‘ˆ ë¡œê·¸ì¸ ì„±ê³µ ì‹œ ë£¨í”„ ì‹œì‘
        }

        // [ë¡œê·¸ì¸ í›„ UI ì „í™˜]
        function showMainMenu() {
            document.querySelector(".g_id_signin").style.display = "none";
            document.getElementById("userInfo").innerText = `ğŸ‘‹ ë°˜ê°‘ìŠµë‹ˆë‹¤, ${userProfile.name}ë‹˜!`;
            document.getElementById("mainMenuView").style.display = "block";
        }

        function logout() {
            localStorage.clear();
            location.reload();
        }

        // [1ë²ˆ] ëª¨ë“  fetch ì‘ë‹µì„ ê²€ì‚¬í•˜ëŠ” ê³µí†µ í•¨ìˆ˜
        async function handleResponse(res) {
            if (res.status === 401) {
                alert("ë³´ì•ˆ ì„¸ì…˜ì´ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.");
                logout(); // ì„¸ì…˜ ë§Œë£Œ ì‹œ ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ ë¹„ìš°ê³  ìƒˆë¡œê³ ì¹¨
                return null;
            }
            if (!res.ok) throw new Error("ì„œë²„ ì‘ë‹µ ì˜¤ë¥˜");
            return res.json();
        }

        // [2ë²ˆ] 50ë¶„ë§ˆë‹¤ í† í°ì„ ìë™ ê°±ì‹ í•˜ëŠ” í•¨ìˆ˜
        function startTokenRefreshLoop() {
            if (window.tokenRefreshInterval) clearInterval(window.tokenRefreshInterval);

            window.tokenRefreshInterval = setInterval(() => {
                if (idToken) {
                    console.log("ğŸ”„ ì„¸ì…˜ ë§Œë£Œ ë°©ì§€ë¥¼ ìœ„í•´ í† í° ìë™ ê°±ì‹  ì¤‘...");
                    // ì¡°ìš©íˆ êµ¬ê¸€ ì„œë²„ì— ìƒˆ í† í°ì„ ìš”ì²­ (handleCredentialResponseê°€ ë‹¤ì‹œ ì‹¤í–‰ë¨)
                    google.accounts.id.prompt();
                }
            }, 50 * 60 * 1000); // 50ë¶„ë§ˆë‹¤ ì‹¤í–‰
        }

        // [ì¹´ë©”ë¼ ì œì–´]
        async function startCamera() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: "user", width: 640, height: 480, frameRate: 15 }, 
                    audio: false 
                });
                videoElement.srcObject = stream;
                document.getElementById('mainMenuView').style.display = 'none';
                document.getElementById('loginArea').style.display = 'none';
                document.getElementById('cameraView').style.display = 'block';
            } catch (err) {
                alert("ì¹´ë©”ë¼ ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤.");
            }
        }

        document.getElementById('startReadyBtn').onclick = startCamera;

        // [ë…¹í™” ë¡œì§ - ê¸°ì¡´ê³¼ ë™ì¼í•˜ë˜ refreshGoogleToken í¬í•¨]
        document.getElementById('recordBtn').onclick = () => {
            refreshGoogleToken();

            // ğŸ“ UI ë³€ê²½: ìƒë‹¨ í…ìŠ¤íŠ¸ ë° íš¨ê³¼
            const statusText = document.getElementById('recordingStatus');
            statusText.innerHTML = '<span class="recording-dot"></span> ë…¹í™” ì¤‘';
            statusText.style.color = "#ff4757"; // ë…¹í™” ì¤‘ì—” ë¹¨ê°„ìƒ‰ìœ¼ë¡œ ë³€ê²½
            
            recordedChunks = [];
            mediaRecorder = new MediaRecorder(videoElement.srcObject);
            mediaRecorder.ondataavailable = e => recordedChunks.push(e.data);
            mediaRecorder.start();
            document.getElementById('recordBtn').style.display = 'none';
            document.getElementById('stopBtn').style.display = 'inline-block';
        };

        document.getElementById('stopBtn').onclick = () => {
            refreshGoogleToken();

            // ğŸ“ UI ë³€ê²½: ë¶„ì„ ì‹œì‘ ì•ˆë‚´
            document.getElementById('recordingStatus').innerText = "ë…¹í™” ì™„ë£Œ! ë¶„ì„ì„ ì‹œì‘í•©ë‹ˆë‹¤...";
            
            mediaRecorder.stop();
            document.getElementById('cameraView').style.display = 'none';
            document.getElementById('loadingView').style.display = 'block';

            mediaRecorder.onstop = async () => {
                const blob = new Blob(recordedChunks, { type: 'video/mp4' });
                const formData = new FormData();
                formData.append('video', blob, 'workout.mp4');

                // UI ì „í™˜
                document.getElementById('cameraView').style.display = 'none';
                document.getElementById('loadingView').style.display = 'flex';
                const loadingText = document.getElementById('loadingText');

                try {
                    const response = await fetch('https://jargonal-flutteringly-sylvester.ngrok-free.dev/analyze', {
                        method: 'POST',
                        body: formData,
                        // ngrok ì‚¬ìš© ì‹œ ë¸Œë¼ìš°ì € ê²½ê³  ì°½ ë°©ì§€
                        headers: { 'ngrok-skip-browser-warning': 'true' }
                    });

                    const reader = response.body.getReader();
                    const decoder = new TextDecoder();

                    while (true) {
                        const { value, done } = await reader.read();
                        if (done) break;

                        const chunk = decoder.decode(value);
                        // ì„œë²„ê°€ ë³´ë‚¸ "data: {...}" ì¤„ì„ íŒŒì‹±
                        const lines = chunk.split('\n');
                        for (const line of lines) {
                            if (line.startsWith('data: ')) {
                                const jsonStr = line.replace('data: ', '');
                                const payload = JSON.parse(jsonStr);

                                if (payload.status === 'PROGRESS') {
                                    // â­ï¸ ì—¬ê¸°ê°€ í¬ì¸íŠ¸: ì„œë²„ì—ì„œ ë³´ë‚¸ msgë¡œ ì‹¤ì‹œê°„ êµì²´
                                    loadingText.innerText = payload.msg;
                                } else if (payload.status === 'DONE') {
                                    // ë¶„ì„ ì™„ë£Œ
                                    workoutResults = payload.data;
                                    document.getElementById('loadingView').style.display = 'none';
                                    document.getElementById('resultView').style.display = 'block';
                                    renderReport();
                                } else if (payload.status === 'ERROR') {
                                    throw new Error(payload.msg);
                                }
                            }
                        }
                    }
                } catch (e) {
                    console.error(e);
                    alert("ë¶„ì„ ì‹¤íŒ¨: " + e.message);
                    location.reload();
                }
            };
        };

        // [ê¸°ë¡ í™•ì¸ ë²„íŠ¼ í´ë¦­ ì‹œ]
        document.getElementById('historyBtn').onclick = () => {
            refreshGoogleToken(); // ë³´ì•ˆ ì„¸ì…˜ ìœ ì§€
            
            // 1. ë©”ì¸ ë©”ë‰´ì™€ ë¡œê·¸ì¸ ì˜ì—­ì„ ìˆ¨ê¹ë‹ˆë‹¤. (ì´ê²Œ í•µì‹¬!)
            document.getElementById('mainMenuView').style.display = 'none';
            document.getElementById('loginArea').style.display = 'none'; 
            
            // 2. ê¸°ë¡ ë·°ë¥¼ ë³´ì—¬ì¤ë‹ˆë‹¤.
            document.getElementById('historyView').style.display = 'block';
            
            loadHistory(); // ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜µë‹ˆë‹¤.
        };

        let currentViewDate = new Date(); // í˜„ì¬ ë³´ê³  ìˆëŠ” ë‹¬ë ¥ ê¸°ì¤€ì¼
        let historyData = {}; // ë‚ ì§œë³„ë¡œ ê·¸ë£¹í™”ëœ ë°ì´í„° ì €ì¥ì†Œ

        // [ê¸°ë¡ ë¶ˆëŸ¬ì˜¤ê¸° ë° ê·¸ë£¹í™”]
        async function loadHistory() {
            const listContainer = document.getElementById('historyList');
            listContainer.innerHTML = "<p>â³ ê¸°ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>";

            try {
                const res = await fetch("https://jargonal-flutteringly-sylvester.ngrok-free.dev/history", {
                    headers: { "Authorization": `Bearer ${idToken}`,
                                    // ğŸ“ ì´ í—¤ë”ê°€ ngrokì˜ HTML ê²½ê³ ì°½ì„ ê±´ë„ˆë›°ê³  ë°”ë¡œ JSONì„ ë°›ê²Œ í•´ì¤ë‹ˆë‹¤.
                            "ngrok-skip-browser-warning": "true"
                    }
                });

                // ë°ì´í„° íŒŒì‹± ì „ ì‘ë‹µ í™•ì¸
                if (res.status === 401) {
                    alert("ì„¸ì…˜ì´ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
                    logout();
                    return;
                }
                
                if (!res.ok) throw new Error("ì„œë²„ ì‘ë‹µ ì‹¤íŒ¨");
                const rawData = await res.json();
                console.log("ğŸ“¥ ìˆ˜ì‹ ëœ ì›ë³¸ ë°ì´í„°:", rawData); // ë””ë²„ê¹…ìš©

                historyData = {};
                if (rawData && Array.isArray(rawData)) {
                    rawData.forEach(item => {
                        if (item.date) {
                            // ì–‘ë ê³µë°± ì œê±° ë° ìˆœìˆ˜ ë‚ ì§œë§Œ ì¶”ì¶œ
                            const dateKey = item.date.trim().substring(0, 10); 
                            if (!historyData[dateKey]) historyData[dateKey] = [];
                            historyData[dateKey].push(item);
                        }
                    });
                }
                console.log("ğŸ“… ê°€ê³µëœ historyData í‚¤ê°’ë“¤:", Object.keys(historyData));
                renderCalendar();

                // ğŸ“ [ì¶”ê°€] ì˜¤ëŠ˜ ë‚ ì§œ ìë™ ì„ íƒ ë¡œì§
                const todayStr = new Date().toISOString().split('T')[0];

                // í™”ë©´ì— ê·¸ë ¤ì§„ ì˜¤ëŠ˜ ë‚ ì§œ ìš”ì†Œë¥¼ ì°¾ìŠµë‹ˆë‹¤.
                const todayElement = document.querySelector(`.calendar-day[onclick*="${todayStr}"]`);
                if (todayElement) {
                    // ì‹¤ì œ í´ë¦­ ì´ë²¤íŠ¸ë¥¼ ë°œìƒì‹œì¼œ í”„ë¦¬ë·°ë¥¼ ë„ì›ë‹ˆë‹¤.
                    selectDate(todayStr, todayElement);
                } else {
                    // ë§Œì•½ ì´ë²ˆ ë‹¬ ë‹¬ë ¥ì— ì˜¤ëŠ˜ì´ ì—†ë‹¤ë©´(ë‹¤ë¥¸ ë‹¬ì„ ë³´ë‹¤ê°€ ë“¤ì–´ì˜¨ ê²½ìš° ë“±) 
                    // í”„ë¦¬ë·° ì˜ì—­ì„ ì´ˆê¸°í™”í•˜ê±°ë‚˜ ì•ˆë‚´ ë¬¸êµ¬ë¥¼ ë„ì›ë‹ˆë‹¤.
                    document.getElementById('dayPreview').innerHTML = 
                        `<p style="color: #666; font-size: 13px; text-align: center; margin: 15px 0;">ì˜¤ëŠ˜ì˜ ìš´ë™ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤. ğŸ’ª</p>`;
                }
            } catch (e) {
                console.error(e);
                listContainer.innerHTML = "<p style='color:#ff4757;'>âŒ ê¸°ë¡ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.</p>";
            }
        }

        // [ë‹¬ë ¥ ë Œë”ë§] - í´ë¦­ ì´ë²¤íŠ¸ì— selectDate ì—°ê²°
        function renderCalendar() {
            const container = document.getElementById('historyList');
            if (!container) return;

            const year = currentViewDate.getFullYear();
            const month = currentViewDate.getMonth();

            const firstDay = new Date(year, month, 1).getDay();
            const lastDate = new Date(year, month + 1, 0).getDate();
            
            let calendarHtml = `
                <div class="calendar-wrapper" id="calWrapper">
                    <div class="calendar-header">
                        <button onclick="changeMonth(-1)" style="background:none; border:none; color:white; font-size:18px; cursor:pointer;">â—€</button>
                        <h3 style="margin:0; color:#2ed573;">${year}ë…„ ${month + 1}ì›”</h3>
                        <button onclick="changeMonth(1)" style="background:none; border:none; color:white; font-size:18px; cursor:pointer;">â–¶</button>
                    </div>
                    <div class="day-names">
                        <div>ì¼</div><div>ì›”</div><div>í™”</div><div>ìˆ˜</div><div>ëª©</div><div>ê¸ˆ</div><div>í† </div>
                    </div>
                    <div class="calendar-grid">`;

            for (let i = 0; i < firstDay; i++) calendarHtml += `<div></div>`;

            const todayStr = new Date().toISOString().split('T')[0];
            for (let i = 1; i <= lastDate; i++) {
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(i).padStart(2, '0')}`;
                const isToday = todayStr === dateStr ? 'today' : '';
                const hasData = historyData[dateStr] ? 'active' : '';
                
                // ğŸ“ onclickì„ showDetail ëŒ€ì‹  selectDateë¡œ ë³€ê²½í•˜ì—¬ í”„ë¦¬ë·° ë¨¼ì € ë³´ì—¬ì¤Œ
                calendarHtml += `
                    <div class="calendar-day ${isToday} ${hasData}" onclick="selectDate('${dateStr}', this)">
                        <span class="day-num">${i}</span>
                        ${hasData ? '<div class="exercise-dot" style="width:4px; height:4px; background:#2ed573; border-radius:50%; margin-top:2px;"></div>' : ''}
                    </div>`;
            }

            calendarHtml += `</div></div>`;
            container.innerHTML = calendarHtml;
            addSwipeEvents();
        }

        // ğŸ“ [ìƒˆë¡œ ì¶”ê°€] ë‚ ì§œ ì„ íƒ ì‹œ í”„ë¦¬ë·° í‘œì‹œ ë¡œì§
        function selectDate(dateStr, element) {
        // ëª¨ë“  ë‚ ì§œì—ì„œ active í´ë˜ìŠ¤ ì œê±° í›„ í´ë¦­í•œ ë‚ ì§œë§Œ ê°•ì¡°
        document.querySelectorAll('.calendar-day').forEach(d => {
            d.style.border = "none";
            d.style.background = "#222"; // ê¸°ë³¸ ë°°ê²½ìœ¼ë¡œ ë³µêµ¬
        });
        element.style.border = "1px solid #2ed573";
        element.style.background = "#121B15"; // ì„ íƒëœ ë‚ ì§œ ë°°ê²½ ê°•ì¡°

        const previewContainer = document.getElementById('dayPreview');
        const logs = historyData[dateStr]; 

        if (logs && logs.length > 0) {
            const [y, m, d] = dateStr.split('-');
            let html = `<div style="color: #2ed573; font-size: 13px; margin-bottom: 12px; font-weight: bold;">
                            ğŸ“ ${parseInt(m)}ì›” ${parseInt(d)}ì¼ ìš´ë™ ìš”ì•½
                        </div>`;
            
            logs.forEach((log, index) => {
                // ğŸ“ ì˜ì—­ ì „ì²´ì— onclick ë¶€ì—¬ ë° ìŠ¤íƒ€ì¼ ì¶”ê°€
                html += `
                    <div class="preview-item" 
                        onclick="showDetail('${dateStr}')" 
                        style="cursor:pointer; display:flex; justify-content:space-between; align-items:center; padding:15px; background:rgba(255,255,255,0.05); border-radius:12px; margin-bottom:10px; border: 1px solid rgba(255,255,255,0.1);">
                        <div style="pointer-events:none;">
                            <span style="color: #eee; font-size: 15px; font-weight: 500;">${log.summary}</span>
                        </div>
                        <span class="preview-tag" style="pointer-events:none;">ë³´ëŸ¬ê°€ê¸° ></span>
                    </div>`;
            });
            previewContainer.innerHTML = html;
        } else {
            previewContainer.innerHTML = `<p style="color: #666; font-size: 13px; text-align: center; width: 100%; margin: 0;">ì´ë‚ ì€ ìš´ë™ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤. ğŸ’ª</p>`;
        }
    }

        function deleteHistoryItem(dateStr) {
            if (confirm(`${dateStr}ì˜ ëª¨ë“  ê¸°ë¡ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                // 1. ë¡œì»¬ ë³€ìˆ˜ì—ì„œ ì‚­ì œ
                delete historyData[dateStr];
                
                // 2. LocalStorage ì—…ë°ì´íŠ¸ (ì €ì¥ ë¡œì§ì´ ìˆëŠ” ê²½ìš°)
                localStorage.setItem('workoutHistory', JSON.stringify(historyData));
                
                // 3. UI ê°±ì‹ 
                renderCalendar(); // ë‹¬ë ¥ ì (dot) ì—…ë°ì´íŠ¸
                document.getElementById('dayPreview').innerHTML = 
                    `<p style="color: #666; font-size: 13px; text-align: center; margin: 20px 0;">ê¸°ë¡ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤. ğŸ—‘ï¸</p>`;
                
                console.log(`${dateStr} ê¸°ë¡ ì‚­ì œ ì™„ë£Œ`);
            }
        }

        // [ì›” ë³€ê²½ í•¨ìˆ˜]
        function changeMonth(diff) {
            currentViewDate.setMonth(currentViewDate.getMonth() + diff);
            renderCalendar();
        }

        function refreshGoogleToken() {
            google.accounts.id.prompt();
        }

        function parseJwtPayload(credential) {
            const base64Url = credential.split('.')[1];
            const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
            
            // ìœ ë‹ˆì½”ë“œ(í•œê¸€)ë¥¼ ì œëŒ€ë¡œ ì§€ì›í•˜ê¸° ìœ„í•œ ë””ì½”ë”© ë°©ì‹
            const jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
                return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
            }).join(''));

            return JSON.parse(jsonPayload);
        }

        // [ìƒì„¸ ë¦¬í¬íŠ¸ ë³´ê¸°]
        function showDetail(date) {
            const dayLogs = historyData[date];
            if (!dayLogs || dayLogs.length === 0) return;

            // í•´ë‹¹ ë‚ ì˜ ëª¨ë“  ìš´ë™ ë°ì´í„°ë¥¼ í†µí•©
            workoutResults = [];
            dayLogs.forEach(log => {
                if (Array.isArray(log.data)) {
                    workoutResults = workoutResults.concat(log.data);
                }
            });

            if (workoutResults.length > 0) {
                viewMode = "history";
                currentIndex = 0;
                document.getElementById('historyView').style.display = 'none';
                document.getElementById('resultView').style.display = 'block';
                renderReport();
            }
        }

        // [ìŠ¤ì™€ì´í”„ ê°ì§€]
        let touchStartX = 0;
        function addSwipeEvents() {
            const wrapper = document.getElementById('calWrapper');
            if (!wrapper) return;
            wrapper.addEventListener('touchstart', e => { touchStartX = e.touches[0].clientX; }, {passive: true});
            wrapper.addEventListener('touchend', e => {
                const touchEndX = e.changedTouches[0].clientX;
                const diff = touchStartX - touchEndX;
                if (Math.abs(diff) > 50) { // 50px ì´ìƒ ì›€ì§ì˜€ì„ ë•Œë§Œ ì‘ë™
                    changeMonth(diff > 0 ? 1 : -1);
                }
            }, {passive: true});
        }

        function updateButtonStates() {
            const historyBtn = document.getElementById('historyBtn');
            
            if (userProfile && idToken) {
                // ë¡œê·¸ì¸ ëœ ìƒíƒœ
                historyBtn.disabled = false;
                historyBtn.style.background = "#2ed573"; // ì›ë˜ ìƒ‰ìƒ
            } else {
                // ë¡œê·¸ì¸ ì•ˆ ëœ ìƒíƒœ
                historyBtn.disabled = true;
            }
        }

        // [ë¦¬í¬íŠ¸ ë Œë”ë§]
        function renderReport() {
            const container = document.getElementById('resultView');
            
            if (!workoutResults || workoutResults.length === 0) return;

            // 1. í˜„ì¬ ì„ íƒëœ íƒ­ì˜ ë°ì´í„° ì •ì˜ (ì´ ë¶€ë¶„ì´ ë¹ ì ¸ì„œ ì—ëŸ¬ê°€ ë‚¬ì—ˆìŠµë‹ˆë‹¤)
            const current = workoutResults[currentIndex];

            // 2. ë‚ ì§œ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
            let currentDateStr = "";
            let displayDate = "";

            if (viewMode === "history") {
                // historyDataì—ì„œ í˜„ì¬ ë°ì´í„°ë¥¼ í¬í•¨í•˜ëŠ” ë‚ ì§œ í‚¤ë¥¼ ì°¾ìŒ
                currentDateStr = Object.keys(historyData).find(date => 
                    historyData[date].some(log => JSON.stringify(log.data).includes(current.exercise))
                );
                displayDate = currentDateStr || "ì´ì „ ê¸°ë¡";
            } else {
                // ë°©ê¸ˆ ì´¬ì˜í•œ ë°ì´í„°ì¸ ê²½ìš° ì˜¤ëŠ˜ ë‚ ì§œ
                currentDateStr = new Date().toISOString().split('T')[0];
                displayDate = "ì˜¤ëŠ˜";
            }

            // 3. íƒ­ ë²„íŠ¼ ìƒì„±
            const tabs = workoutResults.map((item, idx) => `
                <div class="tab-btn ${idx === currentIndex ? 'active' : ''}" 
                    onclick="switchTab(${idx})" 
                    style="
                        display: flex; 
                        align-items: center; 
                        justify-content: center; 
                        min-width: 90px; 
                        min-height: 44px;
                        padding: 5px 15px;
                        text-align: center;
                        word-break: keep-all;
                        line-height: 1.2;
                        cursor: pointer;
                    ">
                    ${item.exercise}
                </div>
            `).join('');

            // 4. ì„¸íŠ¸ ê¸°ë¡ ë¦¬ìŠ¤íŠ¸ ìƒì„±
            const setsList = (current.sets_data || []).map((val, i) => `
                <div style="display: flex; justify-content: space-between; align-items: center; 
                            padding: 12px 16px; background: rgba(255,255,255,0.05); 
                            border-radius: 10px; margin-bottom: 8px;">
                    <span style="color: #888; font-size: 13px;">${i+1}ì„¸íŠ¸</span>
                    <span style="color: #2ed573; font-weight: bold; font-size: 16px;">${val}${current.unit || 'íšŒ'}</span>
                </div>
            `).join('');

            // 5. ìµœì¢… HTML ì‚½ì… (ë²„íŠ¼ ë¶€ë¶„ ì§‘ì¤‘ ìˆ˜ì •)
            container.innerHTML = `
                <div style="text-align: left; padding: 0 10px; margin-top: 20px;">
                    <h2 style="color: #2ed573; margin-bottom: 4px; font-size: 22px;">ğŸ“Š AI ìš´ë™ ë¦¬í¬íŠ¸</h2>
                    <div style="font-size: 13px; color: #666;">${displayDate} ìš´ë™ ê¸°ë¡</div>
                </div>

                <div class="tabs-wrapper" style="margin: 20px 0;">
                    <div class="tabs-container" style="display: flex; gap: 10px; overflow-x: auto; padding: 0 10px;">
                        ${tabs}
                    </div>
                </div>

                <div class="report-card" style="padding: 0 10px;">
                    <div style="margin-bottom: 25px;">
                        <div style="font-size: 11px; color: #444; margin-bottom: 12px; font-weight: bold; letter-spacing: 1px;">SETS DATA</div>
                        ${setsList}
                    </div>
                    
                    <div class="feedback-box" style="text-align: left; background: #1a1f1c; padding: 20px; border-radius: 12px; border-left: 4px solid #2ed573;">
                        <div style="color: #2ed573; font-size: 11px; font-weight: bold; margin-bottom: 10px; letter-spacing: 1px;">AI ANALYSIS</div>
                        <div style="line-height: 1.8; color: #ccc; font-size: 14px; word-break: keep-all;">
                            ${current.feedback || "ë¶„ì„ ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."}
                        </div>
                    </div>
                    
                    <div style="margin-top: 30px; padding-bottom: 40px;">
                        ${viewMode === 'history' ? `
                            <button onclick="goBackToHistory()" class="main-btn" style="width: 100%; height: 54px; border-radius: 12px; background: #2ed573; color: #000; font-weight: bold; border: none; font-size: 16px; margin-bottom: 15px;">
                                â¬…ï¸ ê¸°ë¡ ëª©ë¡ìœ¼ë¡œ ëŒì•„ê°€ê¸°
                            </button>
                            <div style="text-align: center; margin-top: 20px;">
                                <span onclick="deleteAndGoBack('${currentDateStr}')" 
                                    style="color: #555; font-size: 13px; text-decoration: underline; cursor: pointer;">
                                    ì´ë‚ ì˜ ê¸°ë¡ ì „ì²´ ì‚­ì œí•˜ê¸°
                                </span>
                            </div>
                        ` : `
                            <button id="saveBtn" onclick="saveData()" class="main-btn" style="width: 100%; height: 54px; border-radius: 12px; background: #444; color: white; font-weight: bold; border: none; font-size: 16px; margin-bottom: 15px;">
                                ğŸ’¾ ì„œë²„ì— ê¸°ë¡ ì €ì¥í•˜ê¸°
                            </button>
                            <button onclick="goBackToHistory()" class="main-btn" style="width: 100%; height: 54px; border-radius: 12px; background: #2ed573; color: #000; font-weight: bold; border: none; font-size: 16px;">
                                ê¸°ë¡ ëª©ë¡ìœ¼ë¡œ
                            </button>
                        `}
                    </div>
                </div>`;
        }

        async function deleteAndGoBack(dateStr) {
            if (!dateStr || dateStr === "undefined") {
                alert("ì‚­ì œí•  ë‚ ì§œ ì •ë³´ê°€ ëª…í™•í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
                return;
            }

            if (confirm(`${dateStr}ì˜ ëª¨ë“  ê¸°ë¡ì„ ì‚­ì œí•˜ì‹œê² ì–´ìš”?`)) {
                try {
                    // 1. ì„œë²„(DB) ì‚­ì œ ìš”ì²­
                    const response = await fetch(`https://jargonal-flutteringly-sylvester.ngrok-free.dev/delete_by_date?date=${dateStr}`, {
                        method: 'DELETE',
                        headers: { 
                            "Authorization": `Bearer ${idToken}` 
                        }
                    });

                    if (response.ok) {
                        // 2. ë¡œì»¬ ë°ì´í„°(ë©”ëª¨ë¦¬)ì—ì„œ ì¦‰ì‹œ ì‚­ì œ
                        delete historyData[dateStr];
                        
                        // 3. UI ì¦‰ì‹œ ê°±ì‹  (ë‹¬ë ¥ì˜ ì  í‘œì‹œ ì—…ë°ì´íŠ¸)
                        renderCalendar(); 

                        // ğŸ“ [í•µì‹¬ ì¶”ê°€] í”„ë¦¬ë·° ì˜ì—­ì„ ì´ˆê¸° ìƒíƒœë¡œ ë¦¬ì…‹
                        const previewContainer = document.getElementById('dayPreview');
                        if (previewContainer) {
                            previewContainer.innerHTML = `<p style="color: #666; font-size: 13px; text-align: center;">ë‚ ì§œë¥¼ ì„ íƒí•˜ë©´ ìš´ë™ ìš”ì•½ì´ í‘œì‹œë©ë‹ˆë‹¤.</p>`;
                        }
                        goBackToHistory(); // ëª©ë¡ í™”ë©´ìœ¼ë¡œ ì´ë™
                    } else {
                        throw new Error("ì„œë²„ ì‚­ì œ ì‹¤íŒ¨");
                    }
                } catch (e) {
                    console.error("ì‚­ì œ ì¤‘ ì—ëŸ¬:", e);
                    alert("ì„œë²„ ì—°ê²°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‚˜ì¤‘ì— ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
                }
            }
        }

        function switchTab(idx) { currentIndex = idx; renderReport(); }

        async function goBackToHistory() {
            console.log("--- [DEBUG] goBackToHistory ì‹¤í–‰ ì‹œì‘ ---");

            const loadingView = document.getElementById('loadingView');
            const resultView = document.getElementById('resultView');
            const historyView = document.getElementById('historyView');

            // 1. ë·° ì „í™˜
            if (loadingView) loadingView.style.display = 'none'; 
            if (resultView) resultView.style.display = 'none'; 
            if (historyView) historyView.style.display = 'block';

            // 2. [í•µì‹¬] ì„œë²„ì—ì„œ ìµœì‹  ë°ì´í„°ë¥¼ ë‹¤ì‹œ ë¶ˆëŸ¬ì˜µë‹ˆë‹¤.
            // loadHistory ë‚´ë¶€ì— renderCalendar()ì™€ ì˜¤ëŠ˜ ë‚ ì§œ ì„ íƒ ë¡œì§ì´ ì´ë¯¸ í¬í•¨ë˜ì–´ ìˆìŠµë‹ˆë‹¤.
            if (typeof loadHistory === "function") {
                console.log("ğŸ”„ ì„œë²„ì—ì„œ ìµœì‹  ê¸°ë¡ì„ ê°€ì ¸ì˜¤ëŠ” ì¤‘...");
                await loadHistory(); 
            }

            console.log("--- [DEBUG] goBackToHistory ì‹¤í–‰ ì¢…ë£Œ ---");
        }

        // í•¨ìˆ˜ ë°– ìƒë‹¨ì— ìƒíƒœ ê´€ë¦¬ ë³€ìˆ˜ ì¶”ê°€
        let isGuiding = false;
        let isUploading = false;
        let isSaved = false;

        async function saveData() {
            refreshGoogleToken();
            const btn = document.getElementById('saveBtn');
            
            // ì´ë¯¸ ì²˜ë¦¬ ì¤‘ì´ê±°ë‚˜ ì €ì¥ ì™„ë£Œëœ ê²½ìš° ì¤‘ë³µ í´ë¦­ ë°©ì§€
            if (isGuiding || isUploading || isSaved) return;

            // 1. ë¡œê·¸ì¸ ì²´í¬ ë° ìœ ë„ ë¡œì§
            if (!userProfile || !idToken) {
                isGuiding = true;
                const originalText = btn.innerText;
                btn.innerText = "âš ï¸ ë¡œê·¸ì¸ì„ ë¨¼ì € í•´ì£¼ì„¸ìš”";
                btn.style.color = "#ff4757"; // ë¶‰ì€ìƒ‰ìœ¼ë¡œ ê°•ì¡°
                
                setTimeout(() => {
                    btn.innerText = originalText;
                    btn.style.color = "white";
                    isGuiding = false;
                }, 2000);
                return;
            }

            // 2. ì‹¤ì œ ì„œë²„ ì €ì¥ ë¡œì§
            try {
                isUploading = true;
                btn.innerText = "â³ ì €ì¥ ì¤‘...";
                
                const summary = workoutResults.length > 1 
                    ? `${workoutResults[0].exercise} ì™¸ ${workoutResults.length - 1}ì¢…` 
                    : `${workoutResults[0].exercise}`;

                const res = await fetch('https://jargonal-flutteringly-sylvester.ngrok-free.dev/save', {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${idToken}` // ë°±ì—”ë“œ ê²€ì¦ìš© í† í°
                    },
                    body: JSON.stringify({ 
                        summary: summary, 
                        data: workoutResults 
                    })
                });

                const data = await handleResponse(res); // ğŸ“ 401 ì—ëŸ¬ ì²´í¬ ì ìš©
                if (res.ok) { 
                    isSaved = true; 
                    btn.innerText = "âœ… ì €ì¥ ì™„ë£Œ!";
                    btn.style.background = "#555"; // ë¹„í™œì„±í™” ëŠë‚Œì˜ ë°°ê²½ìƒ‰
                    btn.style.color = "white";      // ê¸€ììƒ‰ ê³ ì •
                    btn.disabled = true;            // ë²„íŠ¼ ë¹„í™œì„±í™” (í´ë¦­ ë¶ˆê°€)
                }

            } catch (e) {
                console.error(e);
                btn.innerText = "âŒ ì €ì¥ ì‹¤íŒ¨";
                btn.style.color = "#ff4757";
                setTimeout(() => {
                    btn.innerText = "ğŸ’¾ ë‹¤ì‹œ ì €ì¥ ì‹œë„";
                    btn.style.color = "white";
                    renderReport();
                }, 2000);
            } finally { 
                isUploading = false; 
            }
        }
    </script>
</body>
</html>









